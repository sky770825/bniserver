{% extends "base.html" %}

{% block title %}管理後台 - 簽到系統{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">
        <i class="fas fa-cogs me-2"></i>管理後台
    </h2>
    {% if session.is_admin %}
    <div class="btn-group" role="group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="fas fa-plus me-2"></i>新增活動
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus me-2"></i>新增成員
        </button>
        <button class="btn btn-warning" onclick="fixEventOrganizers()">
            <i class="fas fa-wrench me-2"></i>修復活動發起人
        </button>
    </div>
    {% endif %}
</div>

<div class="row">
    <!-- 統計卡片 -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="fw-bold">{{ users|length }}</h4>
                        <p class="mb-0">總用戶數</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="fw-bold">{{ checkins|length }}</h4>
                        <p class="mb-0">總簽到次數</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="fw-bold">{{ events|length }}</h4>
                        <p class="mb-0">總活動數</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="fw-bold">{{ attendance_rate }}%</h4>
                        <p class="mb-0">平均出勤率</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 最近用戶 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">
                    <i class="fas fa-users me-2"></i>成員列表
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="usersList">
                    <!-- 用戶列表將通過AJAX載入 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 最近簽到 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">
                    <i class="fas fa-history me-2"></i>最近簽到
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshCheckins()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="checkinsList">
                    <!-- 簽到列表將通過AJAX載入 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增活動 Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增活動</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">活動標題</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">活動描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_time" class="form-label">開始時間</label>
                            <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="end_time" class="form-label">結束時間</label>
                            <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">活動地點</label>
                        <input type="text" class="form-control" id="location" name="location">
                    </div>
                    
                    <div class="mb-3">
                        <label for="max_participants" class="form-label">參與人數限制</label>
                        <input type="number" class="form-control" id="max_participants" name="max_participants" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addEvent()">新增活動</button>
            </div>
        </div>
    </div>
</div>

<!-- 新增成員 Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增成員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用戶名 *</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">密碼 *</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">姓名 *</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">電子郵件</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone" class="form-label">電話號碼</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="line_id" class="form-label">LINE ID</label>
                        <input type="text" class="form-control" id="line_id" name="line_id" placeholder="請輸入LINE ID">
                    </div>
                    
                    <div class="mb-3">
                        <label for="position" class="form-label">職級</label>
                        <select class="form-select" id="position" name="position">
                            <option value="">請選擇職級</option>
                            <option value="區董顧">區董顧</option>
                            <option value="執行董顧">執行董顧</option>
                            <option value="董顧">董顧</option>
                            <option value="主席">主席</option>
                            <option value="副主席">副主席</option>
                            <option value="教育組長">教育組長</option>
                            <option value="資訊長">資訊長</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">功能權限</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="can_add_events" name="can_add_events">
                                    <label class="form-check-label" for="can_add_events">
                                        可以新增活動
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="can_edit_events" name="can_edit_events">
                                    <label class="form-check-label" for="can_edit_events">
                                        可以編輯活動
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="can_delete_events" name="can_delete_events">
                                    <label class="form-check-label" for="can_delete_events">
                                        可以刪除活動
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="can_manage_users" name="can_manage_users">
                                    <label class="form-check-label" for="can_manage_users">
                                        可以管理用戶
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="addUser()">新增成員</button>
            </div>
        </div>
    </div>
</div>

<!-- 編輯成員 Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">編輯成員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    <div class="mb-3">
                        <label for="edit_user_username" class="form-label">用戶名</label>
                        <input type="text" class="form-control" id="edit_user_username" readonly>
                        <small class="text-muted">用戶名無法修改</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_name" class="form-label">姓名 *</label>
                        <input type="text" class="form-control" id="edit_user_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_email" class="form-label">電子郵件</label>
                        <input type="email" class="form-control" id="edit_user_email" name="email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_phone" class="form-label">電話號碼</label>
                        <input type="tel" class="form-control" id="edit_user_phone" name="phone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_line_id" class="form-label">LINE ID</label>
                        <input type="text" class="form-control" id="edit_user_line_id" name="line_id" placeholder="請輸入LINE ID">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_position" class="form-label">職級</label>
                        <select class="form-select" id="edit_user_position" name="position">
                            <option value="">請選擇職級</option>
                            <option value="區董顧">區董顧</option>
                            <option value="執行董顧">執行董顧</option>
                            <option value="董顧">董顧</option>
                            <option value="主席">主席</option>
                            <option value="副主席">副主席</option>
                            <option value="教育組長">教育組長</option>
                            <option value="資訊長">資訊長</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">功能權限</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_can_add_events" name="can_add_events">
                                    <label class="form-check-label" for="edit_can_add_events">
                                        可以新增活動
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_can_edit_events" name="can_edit_events">
                                    <label class="form-check-label" for="edit_can_edit_events">
                                        可以編輯活動
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_can_delete_events" name="can_delete_events">
                                    <label class="form-check-label" for="edit_can_delete_events">
                                        可以刪除活動
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_can_manage_users" name="can_manage_users">
                                    <label class="form-check-label" for="edit_can_manage_users">
                                        可以管理用戶
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_user_password" class="form-label">新密碼</label>
                        <input type="password" class="form-control" id="edit_user_password" name="new_password" placeholder="留空表示不修改密碼">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">更新成員</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 載入用戶列表
function loadUsers() {
    $.ajax({
        url: '/admin/users',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                let html = '';
                response.users.forEach(function(user) {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${user.name}</strong>
                                        <br>
                                        <small class="text-muted">用戶名: ${user.username}</small>
                                        <br>
                                        <small class="text-muted">電子郵件: ${user.email || '未設定'}</small>
                                        <br>
                                        <small class="text-muted">電話: ${user.phone || '未設定'}</small>
                                        <br>
                                        <small class="text-muted">LINE ID: ${user.line_id || '未設定'}</small>
                                        <br>
                                        <small class="text-muted">職級: ${user.position ? `<span class="badge bg-primary">${user.position}</span>` : '未設定'}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning btn-sm" onclick="editUser(${user.id}, '${user.username}', '${user.name}', '${user.email || ''}', '${user.phone || ''}', '${user.line_id || ''}', '${user.position || ''}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${user.id}, '${user.name}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                $('#usersList').html(html);
            }
        }
    });
}

// 載入簽到列表
function loadCheckins() {
    $.ajax({
        url: '/admin/checkins',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                let html = '';
                response.checkins.forEach(function(checkin) {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div>
                                <strong>${checkin.user_name}</strong>
                                <br>
                                <small class="text-muted">${checkin.check_in_time}</small>
                            </div>
                            <span class="badge bg-success">已簽到</span>
                        </div>
                    `;
                });
                $('#checkinsList').html(html);
            }
        }
    });
}

function refreshUsers() {
    loadUsers();
}

function refreshCheckins() {
    loadCheckins();
}

function addEvent() {
    const formData = new FormData(document.getElementById('addEventForm'));
    
    $.ajax({
        url: '/admin/events/add',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert('活動新增成功！');
                location.reload();
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('新增活動失敗，請重試');
        }
    });
}

function addUser() {
    const formData = new FormData(document.getElementById('addUserForm'));
    
    $.ajax({
        url: '/admin/users/add',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert('成員新增成功！');
                $('#addUserModal').modal('hide');
                loadUsers();
                document.getElementById('addUserForm').reset();
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('新增成員失敗，請重試');
        }
    });
}

function editUser(userId, username, name, email, phone, lineId, position) {
    // 先獲取用戶的詳細信息
    $.ajax({
        url: `/admin/users/${userId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const user = response.user;
                
                document.getElementById('edit_user_id').value = userId;
                document.getElementById('edit_user_username').value = username;
                document.getElementById('edit_user_name').value = name;
                document.getElementById('edit_user_email').value = email;
                document.getElementById('edit_user_phone').value = phone;
                document.getElementById('edit_user_line_id').value = lineId;
                
                // 設置職級選項
                const positionSelect = document.getElementById('edit_user_position');
                positionSelect.value = position || '';
                
                // 設置權限選項
                const canAddEvents = document.getElementById('edit_can_add_events');
                const canEditEvents = document.getElementById('edit_can_edit_events');
                const canDeleteEvents = document.getElementById('edit_can_delete_events');
                const canManageUsers = document.getElementById('edit_can_manage_users');

                canAddEvents.checked = user.can_add_events || false;
                canEditEvents.checked = user.can_edit_events || false;
                canDeleteEvents.checked = user.can_delete_events || false;
                canManageUsers.checked = user.can_manage_users || false;

                $('#editUserModal').modal('show');
            } else {
                alert('獲取用戶信息失敗：' + response.message);
            }
        },
        error: function() {
            alert('獲取用戶信息失敗，請重試');
        }
    });
}

function updateUser() {
    const userId = document.getElementById('edit_user_id').value;
    const formData = new FormData(document.getElementById('editUserForm'));
    
    $.ajax({
        url: `/admin/users/edit/${userId}`,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert('成員資料更新成功！');
                $('#editUserModal').modal('hide');
                loadUsers();
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('更新成員失敗，請重試');
        }
    });
}

function deleteUser(userId, userName) {
    if (confirm(`確定要刪除成員「${userName}」嗎？此操作無法撤銷。`)) {
        $.ajax({
            url: `/admin/users/delete/${userId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('成員刪除成功！');
                    loadUsers();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('刪除成員失敗，請重試');
            }
        });
    }
}

function fixEventOrganizers() {
    if (confirm('確定要修復所有活動的發起人設置嗎？這將把沒有發起人的活動設置為管理員。')) {
        $.ajax({
            url: '/admin/events/fix_organizers',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // 重新載入頁面以顯示修復後的結果
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('修復活動發起人失敗，請重試');
            }
        });
    }
}

// 頁面載入時執行
$(document).ready(function() {
    loadUsers();
    loadCheckins();
});
</script>
{% endblock %} 